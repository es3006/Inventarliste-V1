unit uLizenzTools;

interface


procedure LizenzCheck;
function CheckLicense: Boolean;
function GetHWID: string;
function LizenzCodeGespeichert: string;
function eMailGespeichert: string;
procedure LizenzSpeichern(const Email, Code: string);
procedure LizenzCodeLoeschen;
procedure EmailLoeschen;
function PruefeLizenzOnline(const Lizenzcode, Email, HWID, Programmname: string): string;


implementation

uses
  Windows, System.UITypes, SysUtils, AnsiStrings, VCL.Forms, IniFiles, IdHTTP, IdSSL, IdSSLOpenSSL, NB30, Dialogs,
  IdSSLOpenSSLHeaders, uMain, IdURI, uLizenzDialog, System.Net.HttpClient, System.JSON;



function Netbios(p: PNCB): Byte; stdcall; external 'netapi32.dll';




procedure LizenzCheck;
var
  dlg: TfLizenzDialog;
begin
  // Prüfen, ob bereits Email und Lizenzcode gespeichert sind
  if (EmailGespeichert <> '') and (LizenzCodeGespeichert <> '') then
    Exit; // schon registriert, nichts tun

  // Dialog erstellen
  dlg := TfLizenzDialog.Create(nil);
  try
    // Vorbelegen, falls Werte vorhanden
    dlg.edEmail.Text := EmailGespeichert;
    dlg.edLizenzcode.Text := LizenzCodeGespeichert;

    // Dialog anzeigen (Modal)
    if dlg.ShowModal = mrOk then
    begin
      // Lizenz wurde erfolgreich überprüft und gespeichert
      // Fokus auf Hauptformular zurückholen
      Application.Restore;
      if Assigned(Application.MainForm) then
      begin
        Application.MainForm.Show;
        Application.MainForm.WindowState := wsNormal;
        Application.MainForm.BringToFront;
        Application.MainForm.SetFocus;
      end;
    end
    else
    begin
      // Benutzer hat abgebrochen → Programm beenden
      Application.Terminate;
    end;

  finally
    dlg.Free;
  end;
end;







function CheckLicense: Boolean;
var
  Http: THttpClient;
  URL, Response: string;
  Json: TJSONObject;
  Antwort, Status, Grund: string;
  LizenzCode, LizenzMail, HWID: string;
begin
  Result := false;

  LizenzCode   := LizenzCodeGespeichert;
  LizenzMail   := EmailGespeichert;
  HWID         := GetHWID;
  Programmname := ChangeFileExt(ExtractFileName(PROGRAMMNAME), '');

// Lizenz online prüfen – Hauptformular muss Programmname + HWID übergeben
  if(Trim(HWID) = '') then
  begin
    showmessage('Keine HWID erkannt');
    exit;
  end;

  if(Trim(Programmname) = '') then
  begin
    showmessage('Keinen Programmnamen erkannt');
    exit;
  end;

  Antwort := PruefeLizenzOnline(LizenzCode, LizenzMail, HWID, Programmname);

  if Pos('|', Antwort) > 0 then
  begin
    Status := Copy(Antwort, 1, Pos('|', Antwort) - 1);
    Grund  := Copy(Antwort, Pos('|', Antwort) + 1, MaxInt);
  end
  else
  begin
    Status := Antwort;
    Grund := '';
  end;

  if Status = 'OK' then
  begin
    Result := true;
  end
  else
  begin
    if Status = 'INACTIVE' then ShowMessage('Lizenz deaktiviert: ' + Grund)
    else if Status = 'EXPIRED' then ShowMessage('Lizenz abgelaufen.')
    else if Status = 'NOT_YET_VALID' then ShowMessage('Lizenz noch nicht gültig.')
    else if Status = 'INVALID' then ShowMessage('E-Mail oder Lizenzcode ungültig.')
    else if Status = 'UNKNOWN_USER' then ShowMessage('Unbekannte E-Mail-Adresse.')
    else if Status = 'UNKNOWN_HWID' then ShowMessage('Unbekannte Hardware ID.')
    else if Status = 'NO_SLOT' then ShowMessage('Maximale Anzahl registrierter Geräte erreicht.')
    else if Status = 'UNKNOWN_HWID' then ShowMessage('Unbekannte Hardware-ID. Lizenz auf diesem Gerät nicht aktiviert.')
    else if Status = 'ERROR' then ShowMessage('Lizenzserver nicht erreichbar.')
    else ShowMessage('Unbekannte Antwort: ' + Antwort);
  end;
end;



function GetVolumeSerial: string;
var
  VolumeSerial: DWORD;
  Dummy1, Dummy2: DWORD;
  VolName, FSName: array[0..MAX_PATH] of Char;
begin
  if GetVolumeInformation('C:\', VolName, MAX_PATH,
    @VolumeSerial, Dummy1, Dummy2, FSName, MAX_PATH) then
    Result := IntToHex(VolumeSerial, 8)
  else
    Result := '00000000';
end;



function GetMacAddress: string;
var
  Adapter: TAdapterStatus;
  NCB: TNCB;
  LanaEnum: TLanaEnum;
  i: Integer;
begin
  Result := '';
  FillChar(NCB, SizeOf(NCB), 0);
  NCB.ncb_command := AnsiChar(NCBENUM);
  NCB.ncb_buffer := @LanaEnum;
  NCB.ncb_length := SizeOf(LanaEnum);

  if Netbios(@NCB) <> 0 then Exit;

  for i := 0 to Ord(LanaEnum.length) - 1 do
  begin
    FillChar(NCB, SizeOf(NCB), 0);
    NCB.ncb_command := AnsiChar(NCBRESET);
    NCB.ncb_lana_num := LanaEnum.lana[i];
    if Netbios(@NCB) <> 0 then Continue;

    FillChar(NCB, SizeOf(NCB), 0);
    NCB.ncb_command := AnsiChar(NCBASTAT);
    NCB.ncb_lana_num := LanaEnum.lana[i];
    AnsiStrings.StrPCopy(NCB.ncb_callname, '*');
    NCB.ncb_buffer := @Adapter;
    NCB.ncb_length := SizeOf(Adapter);

    if Netbios(@NCB) = 0 then
    begin
      Result := Format('%.2X-%.2X-%.2X-%.2X-%.2X-%.2X', [
        Byte(Adapter.adapter_address[0]),
        Byte(Adapter.adapter_address[1]),
        Byte(Adapter.adapter_address[2]),
        Byte(Adapter.adapter_address[3]),
        Byte(Adapter.adapter_address[4]),
        Byte(Adapter.adapter_address[5])
      ]);
      Exit;
    end;
  end;

  if Result = '' then
    Result := '00-00-00-00-00-00';
end;



function GetComputerNameID: string;
var
  Buffer: array[0..MAX_COMPUTERNAME_LENGTH + 1] of Char;
  Size: DWORD;
begin
  Size := Length(Buffer);
  if GetComputerName(Buffer, Size) then
    Result := string(Buffer)
  else
    Result := 'UnknownPC';
end;



function GetHWID: string;
begin
  Result := Format('%s-%s-%s',
    [GetVolumeSerial, GetMacAddress, GetComputerNameID]);
end;



function LizenzCodeGespeichert: string;
var
  Ini: TIniFile;
begin
  Ini := TIniFile.Create(uMain.PATH + 'settings.ini');
  try
    Result := Ini.ReadString('Lizenz', 'Code', '');
  finally
    Ini.Free;
  end;
end;


function eMailGespeichert: string;
var
  Ini: TIniFile;
begin
  Ini := TIniFile.Create(uMain.PATH + 'settings.ini');
  try
    Result := Ini.ReadString('Lizenz', 'Email', '');
  finally
    Ini.Free;
  end;
end;





procedure LizenzSpeichern(const Email, Code: string);
var
  Ini: TIniFile;
begin
  Ini := TIniFile.Create(uMain.PATH + 'settings.ini');
  try
    Ini.WriteString('Lizenz', 'Email', Email);
    Ini.WriteString('Lizenz', 'Code', Code);
  finally
    Ini.Free;
  end;
end;







procedure LizenzCodeLoeschen;
var
  Ini: TIniFile;
begin
  Ini := TIniFile.Create(uMain.PATH + 'settings.ini');
  try
    Ini.DeleteKey('Lizenz', 'Code');
  finally
    Ini.Free;
  end;
end;



procedure EmailLoeschen;
var
  Ini: TIniFile;
begin
  Ini := TIniFile.Create(uMain.PATH + 'settings.ini');
  try
    Ini.DeleteKey('Lizenz', 'Email');
  finally
    Ini.Free;
  end;
end;






function PruefeLizenzOnline(const Lizenzcode, Email, HWID, Programmname: string): string;
var
  HTTP: TIdHTTP;
  SSL: TIdSSLIOHandlerSocketOpenSSL;
  URL: string;
begin
  Result := 'ERROR'; // Standard: Server nicht erreichbar

  HTTP := TIdHTTP.Create(nil);
  SSL := TIdSSLIOHandlerSocketOpenSSL.Create(nil);
  try
    SSL.SSLOptions.Method := sslvTLSv1_2;
    HTTP.IOHandler := SSL;
    HTTP.ReadTimeout := 5000;
    HTTP.HandleRedirects := True;

    URL := 'https://lizenz.ensacom.de/api/check_license.php'
         + '?code=' + Lizenzcode
         + '&email='+ Email
         + '&hwid=' + HWID
         + '&app=' + Programmname;

    try
      Result := Trim(HTTP.Get(URL)); // OK, INVALID, EXPIRED usw.
    except
      on E: Exception do
      begin
        ShowMessage('Fehler beim speichern der Lizenz: ' + E.Message);
        Result := 'ERROR';
      end;
    end;

  finally
    SSL.Free;
    HTTP.Free;
  end;
end;




end.
